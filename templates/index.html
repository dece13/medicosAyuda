<!DOCTYPE html>
<html>

<head>
    <title>Interfaz de chat</title>
    <link rel="stylesheet" href="/static\css/style.css">
    <link rel="icon" href="/static/css/uploads/logo.png" />

</head>

<body>
    <div id="chat-container">
        <div id="chat-messages">
           
            <!-- Aquí se mostrarán los mensajes del chat -->
            {% for message in messages %}
            <p>{{ message.username }}: {{ message.message }}</p>
            {% if message.image %}
            <img src="{{ url_for('static', filename='css/uploads/') }}{{ message.image }}" alt="Imagen">
            {% endif %}
            {% if message.hueso_roto is not none %}
            <p>{{ 'Hueso roto' if message.hueso_roto else 'No roto' }}</p>
            {% endif %}
            {% endfor %}
        </div>
        <div class="inputcontainer">
            <input type="text" class="input__message" id="input-message" placeholder="Escribe tu mensaje...">
            <button class="send__button" id="send-button">Enviar</button>
        </div>

        <input type="file" class="input__image" id="input-image" accept=".jpg, .png, .jpeg">

    </div>

    <script>
        const chatMessages = document.getElementById('chat-messages');
        const inputMessage = document.getElementById('input-message');
        const inputImage = document.getElementById('input-image');
        const sendButton = document.getElementById('send-button');

        sendButton.addEventListener('click', () => {
            const message = inputMessage.value;
            const imageFile = inputImage.files[0];

            // Validación de mensaje no vacío
            if (message.trim() === '') {
                alert('El mensaje no puede estar vacío.');
                return;
            }

            // Validación de selección de imagen
            if (!imageFile) {
                alert('Por favor, selecciona una imagen.');
                return;
            }

            // Crear objeto FormData para enviar el mensaje y la imagen en la solicitud
            const formData = new FormData();
            formData.append('username', 'NombreDeUsuario'); // Cambia 'NombreDeUsuario' por el nombre real del usuario
            formData.append('message', message);
            formData.append('image', imageFile);

            // Enviar los datos al servidor utilizando fetch()
        fetch('/upload', {
            method: 'POST',
            body: formData
        })
        .then(response => response.text())
        .then(result => {
            // Crear un nuevo elemento <p> para el nuevo mensaje y agregarlo al contenedor
            const newMessageElement = document.createElement('p');
            newMessageElement.textContent = 'NombreDeUsuario: ' + message; // Coloca aquí el contenido del mensaje

            // Construir la URL de la imagen utilizando url_for
            const imageSrc = "{{ url_for('static', filename='css/uploads/') }}" + imageFile.name;

            // Agregar primero la imagen, luego el mensaje sobre hueso roto o no
            chatMessages.appendChild(newMessageElement);


            // Crear un nuevo elemento <img> para la imagen y agregarlo al contenedor si existe
            const newImageElement = document.createElement('img');
            newImageElement.src = imageSrc; // Utilizar la URL de la imagen construida
            newImageElement.alt = 'Imagen';
            chatMessages.appendChild(newImageElement);

            
            // Crear un nuevo elemento <p> para la respuesta sobre hueso roto o no
            const newResponseElement = document.createElement('p');
            newResponseElement.textContent = result; // Utilizar el resultado recibido del servidor
            chatMessages.appendChild(newResponseElement);

            inputMessage.value = ''; // Limpiar el campo de entrada de mensajes
        })
        .catch(error => {
            // Manejar errores de la solicitud si los hay
            console.error('Error al enviar la solicitud:', error);
        });
    });
    </script>

</body>

</html>
